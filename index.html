<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kannada TV Schedule ‚Äì SB-KAN</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<style>
:root{
  --bg:#f8fafc;--cardBG:#fff;--text:#212b36;--accent:#3b82f6;--brand:#8b5cf6;
  --glass:rgba(255,255,255,.98);--shadow:0 4px 16px rgba(0,0,0,.09);
  --border:#e2e8f0;--input-bg:#fff;
}
html[data-dark=true]{
  --bg:#0f172a;--cardBG:#1e293b;--text:#e2e8f0;--accent:#60a5fa;--brand:#a78bfa;
  --glass:rgba(30,41,59,0.95);--shadow:0 4px 16px rgba(0,0,0,.3);
  --border:#334155;--input-bg:#334155;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:linear-gradient(135deg,var(--bg) 0%,var(--accent) 100%);color:var(--text);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;transition:all 0.3s ease}
.header{text-align:center;padding:25px 8px 0;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.h-title{font-size:2.2em;font-weight:900;background:linear-gradient(45deg,var(--accent),var(--brand));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0 0 15px;text-shadow:2px 2px 4px rgba(0,0,0,0.1)}
.toolbar{display:flex;justify-content:center;gap:12px;margin:15px 0 20px;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:10px 20px;font:700 0.95em/1 'Segoe UI',Arial,sans-serif;cursor:pointer;box-shadow:var(--shadow);transition:all 0.3s ease;position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s;z-index:1}
.btn:hover::before{left:100%}
.btn{background:var(--cardBG);color:var(--accent);border:2px solid var(--accent)}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
.btn.primary{background:linear-gradient(45deg,var(--accent),var(--brand));color:#fff;border:none}
.btn.admin{background:linear-gradient(45deg,#ff6b6b,#feca57);color:#fff;border:none}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:30px 0;padding:0 15px;max-width:1200px;margin-left:auto;margin-right:auto}
.card{background:var(--cardBG);border-radius:20px;box-shadow:var(--shadow);padding:20px;border:1px solid var(--border);transition:all 0.3s ease;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(45deg,var(--accent),var(--brand))}
.card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
.logo{font-size:1.4em;background:linear-gradient(45deg,var(--accent),var(--brand));color:#fff;border-radius:12px;padding:8px 15px;font-weight:900;margin-right:10px;display:inline-block}
.c-name{font-size:1.2em;font-weight:700;color:var(--text)}
.join{float:right;background:linear-gradient(45deg,var(--accent),var(--brand));color:#fff;border-radius:12px;padding:8px 15px;font-weight:600;font-size:0.9em;text-decoration:none;transition:all 0.3s ease}
.join:hover{transform:scale(1.05)}
.sections{margin-top:15px}
.section{display:flex;justify-content:space-between;align-items:center;margin:12px 0;padding:12px 15px;border-radius:12px;background:var(--glass);font-weight:600;cursor:pointer;border:2px solid transparent;transition:all 0.3s ease;backdrop-filter:blur(5px)}
.section:hover{background:rgba(59,130,246,0.1);border-color:var(--accent);transform:translateX(5px)}
.section.selected{box-shadow:0 0 0 3px var(--modalAccent,#3b82f6);background:rgba(59,130,246,0.2)}
.badge{background:linear-gradient(45deg,var(--brand),var(--accent));color:#fff;border-radius:15px;padding:4px 12px;font-size:0.85em;font-weight:700;min-width:25px;text-align:center}
.all-links{margin:0 15px 25px;padding:18px;border-radius:15px;background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;font-weight:600;text-align:center;box-shadow:var(--shadow)}
.all-links a{color:inherit;padding:0 8px;text-decoration:underline dotted;transition:all 0.2s ease}
.all-links a:hover{background:rgba(255,255,255,0.2);border-radius:8px;padding:4px 8px}
#siteViews{text-align:center;margin:0 0 30px;color:var(--brand);font:700 1.15em/1 'Segoe UI',Arial,sans-serif;letter-spacing:0.1em;text-shadow:1px 1px 2px rgba(0,0,0,0.1)}
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;backdrop-filter:blur(5px)}
.modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:min(400px,95vw);max-height:85vh;background:var(--cardBG);border-radius:20px;box-shadow:0 10px 50px rgba(0,0,0,.3);overflow:hidden;z-index:101;border:1px solid var(--border)}
.m-head{display:flex;justify-content:space-between;align-items:center;padding:18px 15px 15px;background:var(--glass);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
.m-title{font:700 1.2em/1 'Segoe UI',Arial,sans-serif}
.m-title.accent{color:var(--modalAccent,#3b82f6)}
.m-back{border:0;border-radius:10px;padding:8px 18px;background:linear-gradient(45deg,#ef4444,#f97316);color:#fff;font-weight:600;cursor:pointer;transition:all 0.3s ease}
.m-back:hover{transform:scale(1.05)}
.vlist-viewport{max-height:60vh;overflow-y:auto;padding:12px}
.list{margin:0;padding:0;list-style:none;display:flex;flex-direction:column;gap:12px}
.item{background:var(--glass);border-radius:12px;padding:15px;border:1px solid var(--border);transition:all 0.3s ease}
.item:hover{background:rgba(59,130,246,0.05);border-color:var(--accent)}
.i-row{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
.i-meta{display:flex;align-items:center;gap:10px;flex:1}
.title{font-weight:700;color:var(--text)}
.info{font-style:italic;color:var(--brand);font-size:12px;background:rgba(139,92,246,0.1);padding:2px 8px;border-radius:8px}
.time{background:linear-gradient(45deg,var(--modalAccent,#3b82f6),var(--brand));color:#fff;border-radius:15px;padding:6px 15px;font-size:12px;font-weight:600;white-space:nowrap}
.admin-form{padding:20px}
.admin-form input,.admin-form select{width:100%;padding:12px;border-radius:10px;border:2px solid var(--border);margin-bottom:15px;background:var(--input-bg);color:var(--text);font-size:14px;transition:all 0.3s ease}
.admin-form input:focus,.admin-form select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
.admin-form button{background:linear-gradient(45deg,var(--accent),var(--brand));color:white;padding:12px 25px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.3s ease;width:100%}
.admin-form button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
.admin-show-item{background:var(--glass);padding:15px;margin:8px 0;border-radius:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);transition:all 0.3s ease}
.admin-show-item:hover{background:rgba(59,130,246,0.05);border-color:var(--accent)}
.admin-show-buttons button{margin-left:8px;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.3s ease}
.edit-btn{background:linear-gradient(45deg,#f97316,#fbbf24);color:white}
.delete-btn{background:linear-gradient(45deg,#ef4444,#f87171);color:white}
.admin-show-buttons button:hover{transform:scale(1.05)}
.loading{text-align:center;padding:50px;color:var(--brand);font-size:1.2em}
.error-msg{background:#fee;color:#c53030;padding:10px;border-radius:8px;margin:10px 0;text-align:center;font-size:14px}
.success-msg{background:#f0fff4;color:#38a169;padding:10px;border-radius:8px;margin:10px 0;text-align:center;font-size:14px}
@media(max-width:768px){
  .grid{grid-template-columns:1fr;padding:0 10px}
  .modal{width:95vw}
  .toolbar{gap:8px}
  .btn{padding:8px 15px;font-size:0.9em}
}
</style>
</head>
<body>
<header class="header">
  <h1 class="h-title">üì∫ Kannada TV Schedule</h1>
  <div class="toolbar">
    <button id="modeBtn" class="btn">üåô Dark</button>
    <button id="adminBtn" class="btn admin">üîß Admin</button>
    <a class="btn primary" href="https://t.me/SB_KAN" target="_blank">üì± Join SB-KAN</a>
  </div>
</header>
<div class="wrap">
  <div id="loadingMsg" class="loading">üîÑ Loading TV Schedule...</div>
  <div id="grid" class="grid" style="display:none"></div>
  <div class="all-links">
    üìã All Channels Quick Access<br>
    <a href="https://t.me/+HhovoiYWRFNjY2M1">Zee Kannada</a>
    <a href="https://t.me/+7dRHkcEf-fgxZjE1">Colors Kannada</a>
    <a href="https://t.me/+zm5JL22AAx41ZWI1">Star Suvarna</a>
    <a href="https://t.me/+HmSJBcxckzs4MjI1">Udaya TV</a>
    <a href="https://t.me/+0KEBs-FBbrVjMjRl">Zee Power</a>
    <a href="https://t.me/+l5l4SfW3Z_k4OWRl">Weekend Shows</a>
  </div>
  <div id="siteViews">üë• Loading views...</div>
</div>
<div id="overlay" class="overlay"></div>
<div id="modal" class="modal">
  <div class="m-head">
    <div id="mTitle" class="m-title"></div>
    <button id="backBtn" class="m-back">‚Üê Back</button>
  </div>
  <div class="vlist-viewport"><ul id="list" class="list"></ul></div>
</div>

<!-- Admin Modal -->
<div id="adminModal" class="modal">
  <div class="m-head">
    <div class="m-title">üîß Admin Panel</div>
    <button id="adminBackBtn" class="m-back">‚Üê Back</button>
  </div>
  <div class="vlist-viewport">
    <div class="admin-form">
      <div id="statusMsg"></div>
      <form id="showForm">
        <select id="sectionSelect">
          <option value="zee-afternoon">üì∫ Zee Afternoon Shows</option>
          <option value="zee-evening">üåÜ Zee Evening Shows</option>
          <option value="zee-weekend">üéâ Zee Weekend Specials</option>
          <option value="colors-daily">üé® Colors Daily Shows</option>
          <option value="colors-weekend">üé® Colors Weekend Shows</option>
          <option value="suvarna-daily">‚≠ê Suvarna Daily Programs</option>
          <option value="udaya-evening">üåÖ Udaya Evening Lineup</option>
          <option value="power-lineup">‚ö° Power Lineup</option>
        </select>
        <input type="text" id="showName" placeholder="üì∫ Show Name" required>
        <input type="text" id="showTime" placeholder="‚è∞ Time (e.g., 6:00 PM)" required>
        <input type="text" id="showInfo" placeholder="‚ÑπÔ∏è Additional Info (optional)">
        <button type="submit" id="submitBtn">‚ûï Add Show</button>
      </form>
      <div id="adminShowsList"></div>
    </div>
  </div>
</div>

<script>
// Database variables
let db;
let SQL;
let isInitialized = false;

// Section color mapping
const sectionAccents={
  'zee-afternoon':'#3b82f6','zee-evening':'#a78bfa','zee-weekend':'#ef4444',
  'colors-daily':'#f97316','colors-weekend':'#ef4444','suvarna-daily':'#f59e0b',
  'udaya-evening':'#60a5fa','power-lineup':'#10b981','weekend-shows':'#8b5cf6'
};

// Channels configuration
const channels=[
  {name:'Zee Kannada',logo:'üì∫',link:'https://t.me/+HhovoiYWRFNjY2M1',sections:[
    {title:'Afternoon Shows',key:'zee-afternoon'},
    {title:'Evening Shows',key:'zee-evening'},
    {title:'Weekend Specials',key:'zee-weekend'}]},
  {name:'Colors Kannada',logo:'üé®',link:'https://t.me/+7dRHkcEf-fgxZjE1',sections:[
    {title:'Daily Shows',key:'colors-daily'},
    {title:'Weekend Shows',key:'colors-weekend'}]},
  {name:'Star Suvarna',logo:'‚≠ê',link:'https://t.me/+zm5JL22AAx41ZWI1',sections:[
    {title:'Daily Programs',key:'suvarna-daily'}]},
  {name:'Udaya TV',logo:'üåÖ',link:'https://t.me/+HmSJBcxckzs4MjI1',sections:[
    {title:'Evening Lineup',key:'udaya-evening'}]},
  {name:'Zee Power',logo:'‚ö°',link:'https://t.me/+0KEBs-FBbrVjMjRl',sections:[
    {title:'Power Lineup',key:'power-lineup'}]},
  {name:'Weekend Shows',logo:'üéâ',link:'https://t.me/+l5l4SfW3Z_k4OWRl',sections:[
    {title:'Weekend Collection',key:'weekend-shows'}]}
];

// Initial shows data for migration
const initialShows={
  'zee-afternoon':[
    {name:'Maharishi Vaani',time:'8:00 ‚Äì 9:30 AM'},
    {name:'Annapoorna',time:'1:00 PM'},
    {name:'Megha Sandesha',time:'1:30 ‚Äì 2:00 PM',info:'[Mon‚ÄìFri]'},
    {name:'Hrudaya Geethe',time:'2:00 ‚Äì 2:30 PM'},
    {name:'Geetha Govinda',time:'2:30 ‚Äì 3:00 PM'},
    {name:'Manethana',time:'3:00 PM'},
    {name:'Sumangali',time:'3:30 PM'},
    {name:'Raktha Sambandha',time:'4:00 PM'},
    {name:'Kalyanamastu',time:'4:30 PM',info:'[Mon‚ÄìSun]'},
    {name:'Sandhaya Raaga',time:'5:00 ‚Äì 6:00 PM',info:'[Mon‚ÄìSun]'}
  ],
  'zee-evening':[
    {name:'Shrirasthu Shubhamasthu',time:'6:00 PM',info:'[Mon‚ÄìSun]'},
    {name:'Puttakkana Makkalu',time:'6:30 PM',info:'[Mon‚ÄìSun] Re-telecast 12:30 AM'},
    {name:'Amruthadhaare',time:'7:00 PM',info:'[Mon‚ÄìSun]'},
    {name:'Annayya',time:'7:30 PM',info:'Re-telecast 10:30 AM'},
    {name:'Karna',time:'8:00 PM'},
    {name:'Lakshmi Nivasa',time:'8:30 PM'},
    {name:'Shravani Subramanya',time:'9:00 PM',info:'Re-telecast 11:00 AM'},
    {name:'Naa Ninna Bidalaare',time:'9:30 PM'},
    {name:'Brahmagantu',time:'10:00 PM',info:'Re-telecast 10:00 AM'},
    {name:'Soubhagyavati Bhava',time:'10:30 PM'}
  ],
  'zee-weekend':[
    {name:'Mahanati Season 2',time:'7:30 PM'},
    {name:'Naavu Nammavaru',time:'9:00 PM'}
  ],
  'colors-daily':[
    {name:'Maharshi Darshana', time:'7:30 AM', info:'[Mon - Sat]'},
    {name:'Pavada Purasha', time:'1:00 PM', info:'[Mon - Sat]'},
    {name:'Premakavya', time:'6:00 PM', info:'[Mon - Sun]'},
    {name:'Dhristi Bottu', time:'6:30 PM', info:'[Mon - Sun]'},
    {name:'Bhagyalakshmi', time:'7:00 PM', info:'[Mon - Sun]'},
    {name:'Muddu Sose', time:'7:30 PM', info:'[Mon - Sun]'},
    {name:'Ninagaagi', time:'8:00 PM', info:'[Mon - Sun]'},
    {name:'Bhargavi L.L.B', time:'8:30 PM', info:'[Mon - Sun]'},
    {name:'Nandagokula', time:'9:00 PM'},
    {name:'Yajamaana', time:'9:30 PM'},
    {name:'Ramachari', time:'10:00 PM'}
  ],
  'colors-weekend':[
    {name:'Kwatle Kitchen',time:'9:00 PM'}
  ],
  'suvarna-daily':[
    {name:'Suvarna Sankalp',time:'7:30 AM',info:'[Mon‚ÄìSun]'},
    {name:'Bombat Bhojana',time:'12:00 PM'},
    {name:'Preethigagi',time:'1:00 PM'},
    {name:'Anupama ‚Äì Sarvagunaa Sampanne',time:'1:30 ‚Äì 2:30 PM'},
    {name:'Divya Drushti',time:'2:30 ‚Äì 3:30 PM'},
    {name:'Suvarna Gruhamantri 2',time:'5:00 PM'},
    {name:'Gowri Shankara',time:'6:00 PM'},
    {name:'Sharade',time:'6:30 PM'},
    {name:'Aase',time:'7:00 ‚Äì 8:00 PM'},
    {name:'Ninna Jothe Nanna Kathe',time:'8:00 PM'},
    {name:'Snehada Kadalalli',time:'8:30 PM'},
    {name:'Udho Udho Shri Renuka Yellamma',time:'9:00 PM'},
    {name:'Sree Devi Mahatme',time:'9:30 PM'},
    {name:'Avanu Mathe Shravani',time:'10:00 PM'}
  ],
  'udaya-evening':[
    {name:'Nathicharami',time:'6:00 ‚Äì 6:30 PM'},
    {name:'Anna Thangi',time:'6:30 ‚Äì 7:00 PM'},
    {name:'Sindhu Bhairavi',time:'7:00 ‚Äì 7:30 PM'},
    {name:'Shambhavi',time:'7:30 ‚Äì 8:00 PM'},
    {name:'Suryavamsha',time:'8:00 ‚Äì 8:30 PM'},
    {name:'Shanti Nivasa',time:'8:30 ‚Äì 9:00 PM'},
    {name:'Myna',time:'9:00 ‚Äì 9:30 PM'},
    {name:'Anu Pallavi',time:'9:30 ‚Äì 10:00 PM'},
    {name:'Chikkejamani',time:'10:00 ‚Äì 10:30 PM',info:'[Mon‚ÄìSun]'},
    {name:'Sevanthi',time:'10:30 ‚Äì 11:00 PM',info:'[Mon‚ÄìSun]'}
  ],
  'power-lineup':[
    {name:'Bhavishya Darshana',time:'7:30 AM'},
    {name:'Mane Aliya',time:'6:30 PM'},
    {name:'Rajakumari',time:'7:00 PM'},
    {name:'Gowri',time:'7:30 PM'},
    {name:'Jodi Hakki',time:'8:00 PM'},
    {name:'Shubhasya Sheegram',time:'8:30 PM'},
    {name:'Halli Power',time:'9:00 PM'}
  ],
  'weekend-shows':[
    {name:'Weekend Special Movies',time:'All Day',info:'Various Times'}
  ]
};

let shows = {};

// Status message functions
function showStatusMsg(message, type = 'success') {
  const statusDiv = document.getElementById('statusMsg');
  statusDiv.className = type === 'success' ? 'success-msg' : 'error-msg';
  statusDiv.textContent = message;
  statusDiv.style.display = 'block';
  
  setTimeout(() => {
    statusDiv.style.display = 'none';
  }, 3000);
}

// Check localStorage availability and quota
function checkLocalStorageQuota() {
  try {
    const test = 'test';
    localStorage.setItem('test', test);
    localStorage.removeItem('test');
    return true;
  } catch (error) {
    console.warn('localStorage not available:', error);
    return false;
  }
}

// Database functions with improved error handling
async function initDatabase() {
  try {
    console.log('üîÑ Initializing database...');
    SQL = await initSqlJs({
      locateFile: file => `https://sql.js.org/dist/${file}`
    });

    if (!checkLocalStorageQuota()) {
      throw new Error('localStorage not available');
    }

    const savedDb = localStorage.getItem('kannadaTVDB_v3');
    
    if (savedDb) {
      try {
        console.log('üìÇ Loading saved database...');
        const data = new Uint8Array(JSON.parse(savedDb));
        db = new SQL.Database(data);
      } catch (error) {
        console.warn('‚ö†Ô∏è Error loading saved database, creating new:', error);
        db = new SQL.Database();
        createTables();
        migrateExistingData();
      }
    } else {
      console.log('üÜï Creating new database...');
      db = new SQL.Database();
      createTables();
      migrateExistingData();
    }
    
    updateShowsFromDB();
    isInitialized = true;
    console.log('‚úÖ Database initialized successfully');
    
    // Hide loading and show content
    document.getElementById('loadingMsg').style.display = 'none';
    document.getElementById('grid').style.display = 'grid';
    
  } catch (error) {
    console.error('‚ùå Database initialization failed:', error);
    // Fallback to original shows data
    shows = {...initialShows};
    isInitialized = true;
    document.getElementById('loadingMsg').style.display = 'none';
    document.getElementById('grid').style.display = 'grid';
    render();
  }
}

function createTables() {
  db.run(`
    CREATE TABLE IF NOT EXISTS shows (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      section_key TEXT NOT NULL,
      name TEXT NOT NULL,
      time_slot TEXT NOT NULL,
      info TEXT DEFAULT ''
    );
  `);
}

function migrateExistingData() {
  console.log('üìã Migrating initial data...');
  Object.keys(initialShows).forEach(sectionKey => {
    initialShows[sectionKey].forEach(show => {
      db.run(
        'INSERT INTO shows (section_key, name, time_slot, info) VALUES (?, ?, ?, ?)',
        [sectionKey, show.name, show.time, show.info || '']
      );
    });
  });
  saveDatabase();
}

function addShow(sectionKey, name, timeSlot, info = '') {
  try {
    if (!db) {
      throw new Error('Database not initialized');
    }
    
    // Validate inputs
    if (!name.trim() || !timeSlot.trim()) {
      throw new Error('Name and time are required');
    }
    
    db.run(
      'INSERT INTO shows (section_key, name, time_slot, info) VALUES (?, ?, ?, ?)',
      [sectionKey, name.trim(), timeSlot.trim(), info.trim()]
    );
    
    if (!saveDatabase()) {
      throw new Error('Failed to save to storage');
    }
    
    updateShowsFromDB();
    return { success: true, message: '‚úÖ Show added successfully!' };
  } catch (error) {
    console.error('Error adding show:', error);
    return { success: false, message: `‚ùå Error: ${error.message}` };
  }
}

function updateShow(id, name, timeSlot, info) {
  try {
    if (!db) {
      throw new Error('Database not initialized');
    }
    
    // Validate inputs
    if (!name.trim() || !timeSlot.trim()) {
      throw new Error('Name and time are required');
    }
    
    db.run(
      'UPDATE shows SET name = ?, time_slot = ?, info = ? WHERE id = ?',
      [name.trim(), timeSlot.trim(), info.trim(), id]
    );
    
    if (!saveDatabase()) {
      throw new Error('Failed to save to storage');
    }
    
    updateShowsFromDB();
    return { success: true, message: '‚úÖ Show updated successfully!' };
  } catch (error) {
    console.error('Error updating show:', error);
    return { success: false, message: `‚ùå Error: ${error.message}` };
  }
}

function deleteShow(id) {
  try {
    if (!db) {
      throw new Error('Database not initialized');
    }
    
    db.run('DELETE FROM shows WHERE id = ?', [id]);
    
    if (!saveDatabase()) {
      throw new Error('Failed to save to storage');
    }
    
    updateShowsFromDB();
    return { success: true, message: '‚úÖ Show deleted successfully!' };
  } catch (error) {
    console.error('Error deleting show:', error);
    return { success: false, message: `‚ùå Error: ${error.message}` };
  }
}

function getShowsBySection(sectionKey) {
  try {
    if (!db) return [];
    
    const stmt = db.prepare('SELECT * FROM shows WHERE section_key = ? ORDER BY time_slot');
    const results = [];
    stmt.bind([sectionKey]);
    while (stmt.step()) {
      results.push(stmt.getAsObject());
    }
    stmt.free();
    return results;
  } catch (error) {
    console.error('Error getting shows:', error);
    return [];
  }
}

function updateShowsFromDB() {
  try {
    // Initialize all sections
    Object.keys(initialShows).forEach(sectionKey => {
      shows[sectionKey] = [];
    });
    
    // Add weekend-shows if missing
    if (!shows['weekend-shows']) {
      shows['weekend-shows'] = [];
    }
    
    // Update from database
    Object.keys(shows).forEach(sectionKey => {
      const dbShows = getShowsBySection(sectionKey);
      shows[sectionKey] = dbShows.map(show => ({
        name: show.name,
        time: show.time_slot,
        info: show.info
      }));
    });
    
    render();
  } catch (error) {
    console.error('Error updating shows from DB:', error);
  }
}

function saveDatabase() {
  try {
    if (!db) return false;
    
    // Check if localStorage is available
    if (!checkLocalStorageQuota()) {
      console.warn('localStorage quota exceeded or blocked');
      return false;
    }
    
    const data = db.export();
    const dataArray = Array.from(data);
    
    // Check data size (localStorage limit is typically 5MB)
    const dataSize = JSON.stringify(dataArray).length;
    const maxSize = 4 * 1024 * 1024; // 4MB limit to be safe
    
    if (dataSize > maxSize) {
      console.warn('Database too large for localStorage');
      return false;
    }
    
    localStorage.setItem('kannadaTVDB_v3', JSON.stringify(dataArray));
    return true;
    
  } catch (error) {
    console.error('Error saving database:', error);
    
    // Try to clear some space and retry once
    try {
      localStorage.removeItem('kannadaTVDB_v2');
      localStorage.removeItem('kannadaTVDB');
      localStorage.setItem('kannadaTVDB_v3', JSON.stringify(Array.from(db.export())));
      return true;
    } catch (retryError) {
      console.error('Retry save failed:', retryError);
      return false;
    }
  }
}

// Render functions
function render(){
  const grid = document.getElementById('grid');
  if (!grid) return;
  
  grid.innerHTML = '';
  
  channels.forEach(ch => {
    const sectionsHTML = ch.sections.map(s => {
      const count = (shows[s.key] || []).length;
      return `
        <div class="section" data-key="${s.key}" onclick="openSec('${s.key}','${s.title}')">
          <span>üìë ${s.title}</span>
          <span class="badge">${count}</span>
        </div>`;
    }).join('');
    
    grid.insertAdjacentHTML('beforeend',`
      <div class="card">
        <div>
          <span class="logo">${ch.logo}</span>
          <span class="c-name">${ch.name}</span>
          <a class="join" href="${ch.link}" target="_blank">Join üì±</a>
        </div>
        <div class="sections">
          ${sectionsHTML}
        </div>
      </div>`);
  });
}

function openSec(key,title){
  document.querySelectorAll('.section').forEach(e=>e.classList.remove('selected'));
  document.querySelectorAll(`[data-key="${key}"]`).forEach(e=>e.classList.add('selected'));
  document.getElementById('modal').style.setProperty('--modalAccent',sectionAccents[key]||'#3b82f6');
  document.getElementById('mTitle').textContent = 'üì∫ ' + title;
  document.getElementById('mTitle').className='m-title accent';

  const ul=document.getElementById('list');
  ul.innerHTML='';
  
  const sectionShows = shows[key] || [];
  
  if (sectionShows.length === 0) {
    ul.innerHTML = '<li class="item"><div class="i-row"><div class="i-meta"><span class="title">üé¨ No shows added yet</span><span class="info">Use Admin panel to add shows</span></div></div></li>';
  } else {
    sectionShows.forEach((show, index) => {
      ul.insertAdjacentHTML('beforeend',`
        <li class="item">
          <div class="i-row">
            <div class="i-meta">
              <span class="title">üé≠ ${show.name}</span>
              ${show.info ? `<span class="info">${show.info}</span>` : ''}
            </div>
            <span class="time">‚è∞ ${show.time}</span>
          </div>
        </li>`);
    });
  }
  
  document.getElementById('overlay').style.display='block';
  document.getElementById('modal').style.display='block';
}

// Admin functions
function showAdminPanel() {
  const password = prompt('üîê Enter admin password:');
  if (password === 'sbkan2025') {
    document.getElementById('overlay').style.display = 'block';
    document.getElementById('adminModal').style.display = 'block';
    loadAdminShows();
  } else if (password !== null) {
    alert('‚ùå Wrong password!');
  }
}

function loadAdminShows() {
  const sectionKey = document.getElementById('sectionSelect').value;
  const showsList = document.getElementById('adminShowsList');
  const dbShows = getShowsBySection(sectionKey);
  
  showsList.innerHTML = `<h4>üìã Current Shows (${dbShows.length}):</h4>` + 
    dbShows.map(show => `
      <div class="admin-show-item">
        <div>
          <strong>üé≠ ${show.name}</strong><br>
          <small>‚è∞ ${show.time_slot} ${show.info ? '‚Ä¢ ' + show.info : ''}</small>
        </div>
        <div class="admin-show-buttons">
          <button class="edit-btn" onclick="editShow(${show.id}, '${show.name.replace(/'/g, "\\'")}', '${show.time_slot.replace(/'/g, "\\'")}', '${(show.info || '').replace(/'/g, "\\'")}')">‚úèÔ∏è Edit</button>
          <button class="delete-btn" onclick="deleteShowConfirm(${show.id})">üóëÔ∏è Delete</button>
        </div>
      </div>
    `).join('');
}

let editingShowId = null;

function editShow(id, name, timeSlot, info) {
  document.getElementById('showName').value = name;
  document.getElementById('showTime').value = timeSlot;
  document.getElementById('showInfo').value = info || '';
  document.getElementById('submitBtn').textContent = 'üíæ Update Show';
  editingShowId = id;
}

function deleteShowConfirm(id) {
  if (confirm('üóëÔ∏è Are you sure you want to delete this show?')) {
    const result = deleteShow(id);
    showStatusMsg(result.message, result.success ? 'success' : 'error');
    if (result.success) {
      loadAdminShows();
    }
  }
}

function handleAddShow(e) {
  e.preventDefault();
  const sectionKey = document.getElementById('sectionSelect').value;
  const name = document.getElementById('showName').value;
  const timeSlot = document.getElementById('showTime').value;
  const info = document.getElementById('showInfo').value;
  
  let result;
  
  if (editingShowId) {
    result = updateShow(editingShowId, name, timeSlot, info);
    editingShowId = null;
    document.getElementById('submitBtn').textContent = '‚ûï Add Show';
  } else {
    result = addShow(sectionKey, name, timeSlot, info);
  }
  
  showStatusMsg(result.message, result.success ? 'success' : 'error');
  
  if (result.success) {
    document.getElementById('showForm').reset();
    loadAdminShows();
  }
}

// Theme toggle function
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-dark') === 'true';
  const newTheme = !isDark;
  
  html.setAttribute('data-dark', newTheme);
  document.getElementById('modeBtn').textContent = newTheme ? '‚òÄÔ∏è Light' : 'üåô Dark';
  
  // Save theme preference
  try {
    localStorage.setItem('theme', newTheme ? 'dark' : 'light');
  } catch (error) {
    console.warn('Could not save theme preference:', error);
  }
}

// Load saved theme
function loadTheme() {
  try {
    const savedTheme = localStorage.getItem('theme') || 'light';
    const html = document.documentElement;
    
    if (savedTheme === 'dark') {
      html.setAttribute('data-dark', 'true');
      document.getElementById('modeBtn').textContent = '‚òÄÔ∏è Light';
    } else {
      html.setAttribute('data-dark', 'false');
      document.getElementById('modeBtn').textContent = 'üåô Dark';
    }
  } catch (error) {
    console.warn('Could not load theme preference:', error);
  }
}

// Event listeners
document.getElementById('modeBtn').onclick = toggleTheme;

document.getElementById('backBtn').onclick = document.getElementById('overlay').onclick = () => {
  document.getElementById('overlay').style.display='none';
  document.getElementById('modal').style.display='none';
  document.getElementById('adminModal').style.display='none';
  document.querySelectorAll('.section').forEach(e=>e.classList.remove('selected'));
  editingShowId = null;
  document.getElementById('submitBtn').textContent = '‚ûï Add Show';
};

document.getElementById('adminBtn').onclick = showAdminPanel;

document.getElementById('adminBackBtn').onclick = () => {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('adminModal').style.display = 'none';
  editingShowId = null;
  document.getElementById('submitBtn').textContent = '‚ûï Add Show';
  document.getElementById('showForm').reset();
  document.getElementById('statusMsg').style.display = 'none';
};

document.getElementById('showForm').onsubmit = handleAddShow;

document.getElementById('sectionSelect').onchange = () => {
  loadAdminShows();
  editingShowId = null;
  document.getElementById('submitBtn').textContent = '‚ûï Add Show';
  document.getElementById('showForm').reset();
  document.getElementById('statusMsg').style.display = 'none';
};

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
  loadTheme();
  initDatabase();
  
  // Global view counter
  fetch('https://api.countapi.xyz/hit/kndtv/v1')
    .then(r=>r.json())
    .then(d=>{document.getElementById('siteViews').textContent=`üë• ${d.value.toLocaleString()} views`;})
    .catch(()=>{document.getElementById('siteViews').textContent='üë• Views: Loading...'});
});
</script>
</body>
</html>
